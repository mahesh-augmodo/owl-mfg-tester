syntax = "proto3";

package dutTestAgent;

import "google/protobuf/empty.proto";

option go_package = "owl_prober/proto/";

message GetAgentDetailsRequest {}

message GetAgentDetailsResponse {
  string agent_version = 1; // The version of the agent software.
  string device_id = 2;     // The ID of the Device Under Test (DUT) the agent is currently connected to.
  string mac_addr = 3;
  string ip_addr = 4;
}

message OLEDSettings {
	string I2CBusName = 1;
	int32 DevAddr = 2;
	int32 Width = 3;
	int32 Height   = 4;  
	int32 PowerPin  = 5;
  int32 ResetPin  = 6;
} 

message SetOLEDTextRequest {
  string text = 1;
}

message BatterySettings {
  string device_name = 1;
  string voltage_node = 2;
  string current_node = 3;
  string temp_node = 4;
}

message GetBatteryReadingsRequest {}

message GetBatteryReadingsResponse {
  float millivolts = 1;
  float milliamps = 2;
  float celsius_temperature = 3;
  bool present = 4;
  string status = 5; // e.g., "Charging", "Discharging", "Full"
}

message EventDevice {
  string device_name = 1;
  string device_path = 2;
  string device_type = 3;
  string sysfs_path = 4;
}

message GetEventReportOverDurationRequest {
  string device_path = 1;
  int32 duration_seconds = 2;
}

message GetEventReportOverDurationResponse {
  string csv_report = 1;
}

message DiscoverEventDevicesRequest {}

message DiscoverEventDevicesResponse {
  repeated EventDevice devices = 1;
}

message BuzzerSettings {
  string device_path = 1;
}

message SetBuzzerRequest {
  bool on = 1;
}

message GetSystemStateRequest {
  int32 idle_duration_seconds = 1; // Duration for idle percentage calculation
  string cpu_temperature_sysfs_path = 2; // Path to CPU temperature sysfs file
}

message GetSystemStateResponse {
  string serial = 1;
  float cpu_temperature = 2; // In Celsius
  float cpu_idle_percent = 3;
  uint64 total_memory_kb = 4;
  float cpu_load_average = 5;
}

message UploadFileRequest {
  string filename = 1;
  bytes chunk_data = 2;
  int64 offset = 3;
  int64 total_size = 4;
}

message UploadFileResponse {
  string message = 1;
  bool success = 2;
}

message DownloadFileRequest {
  string filename = 1;
}

message DownloadFileResponse {
  bytes chunk_data = 1;
  int64 offset = 2;
  int64 total_size = 3;
}

service DutAgentService {
  // GetAgentDetails retrieves basic identification and status information about the agent.
  // This can be used as a simple health check and to verify agent connectivity.
  rpc GetAgentDetails (GetAgentDetailsRequest) returns (GetAgentDetailsResponse);

  rpc RunCommand (RunCommandRequest) returns (RunCommandResponse);

  // GetDeviceInfo retrieves basic identification and status information about the DUT.
  rpc GetDeviceInfo (GetDeviceInfoRequest) returns (GetDeviceInfoResponse);

  // StreamExecutionLogs enables server-side streaming of execution logs from the agent to the client.
  rpc StreamExecutionLogs (StreamExecutionLogsRequest) returns (stream LogEntry);
  
  // ConfigureOLEDDisplay sets the configuration for the OLED display.
  rpc ConfigureOLEDDisplay (OLEDSettings) returns (google.protobuf.Empty);

  // SetOLEDStaticText displays a static text message on the OLED.
  rpc SetOLEDStaticText (SetOLEDTextRequest) returns (google.protobuf.Empty);

  // SetOLEDScrollingText displays a scrolling text message on the OLED.
  rpc SetOLEDScrollingText (SetOLEDTextRequest) returns (google.protobuf.Empty);

  // ConfigureBattery sets the configuration for battery readings.
  rpc ConfigureBattery (BatterySettings) returns (google.protobuf.Empty);

  // GetBatteryReadings retrieves the current battery readings.
  rpc GetBatteryReadings (GetBatteryReadingsRequest) returns (GetBatteryReadingsResponse);

  // DiscoverEventDevices scans for available input event devices.
  rpc DiscoverEventDevices (DiscoverEventDevicesRequest) returns (DiscoverEventDevicesResponse);

  // GetEventReportOverDuration captures and reports input events for a specified duration as a CSV string.
  rpc GetEventReportOverDuration (GetEventReportOverDurationRequest) returns (GetEventReportOverDurationResponse);

  // ConfigureBuzzer sets the device path for the buzzer.
  rpc ConfigureBuzzer (BuzzerSettings) returns (google.protobuf.Empty);

  // SetBuzzer turns the buzzer on or off.
  rpc SetBuzzer (SetBuzzerRequest) returns (google.protobuf.Empty);

  // GetSystemState retrieves various system related information (CPU, memory, serial).
  rpc GetSystemState (GetSystemStateRequest) returns (GetSystemStateResponse);

  // UploadFile allows client to upload a file to the agent.
  rpc UploadFile (stream UploadFileRequest) returns (UploadFileResponse);

  // DownloadFile allows client to download a file from the agent.
  rpc DownloadFile (DownloadFileRequest) returns (stream DownloadFileResponse);
}

message RunCommandRequest {
  string command = 1;          // The command to execute (e.g., "ls", "adb shell getprop").
  repeated string args = 2;    // Arguments to pass to the command.
  int32 timeout_seconds = 3;   // Timeout for the command execution in seconds.
  string working_directory = 4; // (Optional) Working directory for the command.
}

message RunCommandResponse {
  int32 exit_code = 1;       // The exit code of the executed command.
  string stdout = 2;         // Standard output from the command.
  string stderr = 3;         // Standard error from the command.
  string error_message = 4;  // Any error message generated by the agent itself (e.g., timeout, command not found).
}

message GetDeviceInfoRequest {}

message GetDeviceInfoResponse {
  string device_id = 1;      // The DeviceID of the badge.
  // A map for any other arbitrary key-value device properties.
  map<string, string> custom_fields = 5; 
}

enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  LOG_LEVEL_DEBUG = 1;
  LOG_LEVEL_INFO = 2;
  LOG_LEVEL_WARN = 3;
  LOG_LEVEL_ERROR = 4;
  LOG_LEVEL_FATAL = 5;
}

message StreamExecutionLogsRequest {
  LogLevel min_level = 1; // Only stream logs with this level or higher severity.
  string component_filter = 2; // (Optional) Filter logs by a specific component name.
  bool follow = 3; // If true, stream new logs as they are generated; otherwise, send historical logs and close.
}

message LogEntry {
  string timestamp = 1; // ISO 8601 formatted timestamp, e.g., "2006-01-02T15:04:05Z07:00"
  LogLevel level = 2;
  string component = 3; // (Optional) The component or module that generated the log.
  string message = 4;
}